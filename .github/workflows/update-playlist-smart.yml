# T√™n t·ªáp: .github/workflows/update-playlist-smart.yml

name: Update SMART Geo-Optimized Playlist

on:
  # Cho ph√©p ch·∫°y th·ªß c√¥ng t·ª´ tab Actions
  workflow_dispatch:

  # L√™n l·ªãch ch·∫°y t·ª± ƒë·ªông 2 l·∫ßn m·ªói ng√†y v√†o 09:00 v√† 21:00 UTC
  schedule:
    - cron: '0 9,21 * * *'

jobs:
  update-playlist:
    runs-on: ubuntu-latest

    steps:
      # B∆∞·ªõc 1: L·∫•y m√£ ngu·ªìn t·ª´ kho l∆∞u tr·ªØ
      - name: Checkout repository
        uses: actions/checkout@v4

      # B∆∞·ªõc 2: C√†i ƒë·∫∑t m√¥i tr∆∞·ªùng Python 3.11
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # B·∫≠t cache ƒë·ªÉ tƒÉng t·ªëc ƒë·ªô c√†i ƒë·∫∑t th∆∞ vi·ªán

      # B∆∞·ªõc 3: C√†i ƒë·∫∑t c√°c th∆∞ vi·ªán c·∫ßn thi·∫øt
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # B∆∞·ªõc 4: Ch·∫°y script ch√≠nh ƒë·ªÉ t·∫°o playlist
      - name: Run IPTV Generator
        run: python iptv_generator_smart_geo.py

      # B∆∞·ªõc 5: T·ª± ƒë·ªông c·∫≠p nh·∫≠t c√°c s·ªë li·ªáu th·ªëng k√™ v√†o README.md
      - name: Update README with stats
        run: |
          # L·∫•y c√°c gi√° tr·ªã t·ª´ t·ªáp log v√† playlist
          # S·ª≠ d·ª•ng tail -n 1 ƒë·ªÉ ƒë·∫£m b·∫£o l·∫•y s·ªë li·ªáu t·ª´ d√≤ng t√≥m t·∫Øt cu·ªëi c√πng
          CHANNELS_COUNT=$(grep -oP '#EXTINF:-1,Total: \K\d+' playlist.m m·ªôtu | head -n 1)
          VN_SERVERS_COUNT=$(grep -oP '‚Üí VN servers: \K\d+' iptv_generator.log | tail -n 1)
          SG_SERVERS_COUNT=$(grep -oP '‚Üí SG servers: \K\d+' iptv_generator.log | tail -n 1)
          SMART_FINDS_COUNT=$(grep -oP '‚ú® SMART FINDS: \K\d+' iptv_generator.log | tail -n 1)
          HIGH_CONF_COUNT=$(grep -oP 'High confidence detections: \K\d+' iptv_generator.log | tail -n 1)
          
          # ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh l√† 0 n·∫øu kh√¥ng t√¨m th·∫•y
          CHANNELS_COUNT=${CHANNELS_COUNT:-0}
          VN_SERVERS_COUNT=${VN_SERVERS_COUNT:-0}
          SG_SERVERS_COUNT=${SG_SERVERS_COUNT:-0}
          SMART_FINDS_COUNT=${SMART_FINDS_COUNT:-0}
          HIGH_CONF_COUNT=${HIGH_CONF_COUNT:-0}

          # L·∫•y th·ªùi gian c·∫≠p nh·∫≠t UTC v√† ƒë·ªãnh d·∫°ng cho huy hi·ªáu (badge)
          UPDATED_TIME_UTC=$(date -u +"%Y-%m-%d %H:%M UTC")
          UPDATED_TIME_ENCODED=$(echo "$UPDATED_TIME_UTC" | sed 's/ /%20/g')

          # L·∫•y t√™n repo ƒë·ªÉ ƒëi·ªÅn v√†o README
          REPO_NAME="${{ github.repository }}"

          # Thay th·∫ø c√°c placeholder trong README.md
          sed -i "s/__CHANNELS__/$CHANNELS_COUNT/g" README.md
          sed -i "s/__VN_SERVERS__/$VN_SERVERS_COUNT/g" README.md
          sed -i "s/__SG_SERVERS__/$SG_SERVERS_COUNT/g" README.md
          sed -i "s/__SMART_FINDS__/$SMART_FINDS_COUNT/g" README.md
          sed -i "s/__HIGH_CONF__/$HIGH_CONF_COUNT/g" README.md
          sed -i "s|__REPO__|$REPO_NAME|g" README.md
          sed -i "s/__UPDATED_TIME_ENCODED__/$UPDATED_TIME_ENCODED/g" README.md

      # B∆∞·ªõc 6: Commit v√† ƒë·∫©y c√°c thay ƒë·ªïi l√™n kho l∆∞u tr·ªØ
      - name: Commit and push changes
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add playlist.m3u README.md iptv_generator.log
          
          # Ch·ªâ commit n·∫øu c√≥ s·ª± thay ƒë·ªïi
          if ! git diff --staged --quiet; then
            git commit -m "üöÄ Automated playlist update - $(date -u +'%Y-%m-%d %H:%M UTC')"
            git push
          else
            echo "No changes to commit."
          fi
